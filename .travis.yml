sudo: true
language: rust
env:
  matrix:
    - DIST: "disco"
      RUST_VER: "stable"
    - DIST: "disco"
      RUST_VER: "nightly"
    - DIST: "bionic"
      RUST_VER: "stable"
    - DIST: "bionic"
      RUST_VER: "nightly"
deploy:
  provider: pages
  skip-cleanup: true
  github-token: $GH_TOKEN
  keep-history: true
  verbose: true
  target_branch: gh-pages
  local-dir: target/doc
  on:
    branch: pages-ci

before_install:
  - docker run -d --name ubuntu-test -v $(pwd):/travis ubuntu:$DIST tail -f /dev/null
  - docker ps
install:
  - docker exec -t ubuntu-test bash -c "apt-get update;
    apt-get install -y libgtk-3-dev gettext appstream-util desktop-file-utils gcc g++ curl meson;"
script:
  - travis_wait 45 docker exec -t ubuntu-test bash -c "(curl https://sh.rustup.rs -sSf | sh -s -- -y) &&
    source \$HOME/.cargo/env &&
    cd /travis &&
    rustup install $RUST_VER &&
    rustc --version &&
    meson _build &&
    ninja -C _build test"
after_success: |
  cargo rustdoc -- --document-private-items &&
  echo '<meta http-equiv="refresh" content="0;url=https://cogitri.github.io/gxi/gxi">' > target/doc/index.html
